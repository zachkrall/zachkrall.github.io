"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.renderApp = undefined;

var _extends2 = require("babel-runtime/helpers/extends");

var _extends3 = _interopRequireDefault(_extends2);

require("isomorphic-fetch");

var _simpleJsonFetch = require("simple-json-fetch");

var _simpleJsonFetch2 = _interopRequireDefault(_simpleJsonFetch);

var _react = require("react");

var React = _interopRequireWildcard(_react);

var _reactDom = require("react-dom");

var _reactDom2 = _interopRequireDefault(_reactDom);

var _reactHotLoader = require("react-hot-loader");

var _url = require("@phenomic/api-client/lib/url");

var _url2 = _interopRequireDefault(_url);

var _Provider = require("./components/Provider");

var _Provider2 = _interopRequireDefault(_Provider);

var _store = require("./shared/store");

var _store2 = _interopRequireDefault(_store);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var debug = require("debug")("phenomic:plugin:react");

var render = typeof document !== "undefined" && !document.querySelector("#phenomic-DevLoader") && _reactDom2.default.hydrate ? _reactDom2.default.hydrate : _reactDom2.default.render;

var store = void 0;

var renderApp = exports.renderApp = function renderApp(routes) {
  debug("client rendering");

  function createFetchFunction() {
    return function (config) {
      return (0, _simpleJsonFetch2.default)((0, _url2.default)((0, _extends3.default)({}, config, { root: "/phenomic" }))).then(function (res) {
        return res.json;
      });
    };
  }

  var initialStateNode = document.getElementById("PhenomicHydration");
  store = store || (0, _store2.default)(initialStateNode && initialStateNode.textContent ? JSON.parse(initialStateNode.textContent) : undefined);

  var root = document.getElementById("PhenomicRoot");
  if (!root) {
    root = document.createElement("div");
    root.id = "PhenomicRoot";
    if (!document.body) {
      throw new Error("Rendering the app without a body element is impossible");
    }
    document.body.appendChild(root);
  }

  render(React.createElement(
    _reactHotLoader.AppContainer,
    null,
    React.createElement(
      _Provider2.default,
      { fetch: createFetchFunction(), store: store },
      routes()
    )
  ), root);
};

exports.default = function (routes) {
  if (typeof window !== "undefined") {
    renderApp(routes);
  }
  return {
    routes: routes()
  };
};